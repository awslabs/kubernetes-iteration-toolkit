apiVersion: karpenter.k8s.aws/v1
kind: EC2NodeClass
metadata:
  name: titan-class
spec:
  amiFamily: Custom
  amiSelectorTerms:
  - alias: "al2023@${ALIAS_VERSION}"
  instanceProfile: KarpenterNodeInstanceProfile-${CLUSTER_NAME}
  kubelet:
    evictionHard:
      memory.available: 5%
      nodefs.available: 10%
      nodefs.inodesFree: 10%
    kubeReserved:
      cpu: 100m
      ephemeral-storage: 1Gi
      memory: 100Mi
    maxPods: 110
    systemReserved:
      cpu: 100m
      ephemeral-storage: 1Gi
      memory: 100Mi
  metadataOptions:
    httpEndpoint: enabled
    httpProtocolIPv6: disabled
    httpPutResponseHopLimit: 1
    httpTokens: required
  securityGroupSelectorTerms:
  - tags:
      karpenter.sh/discovery: "${CLUSTER_NAME}"
  - tags:
      aws:cloudformation:stack-name: "${CLUSTER_NAME}"
  - tags:
      kubernetes.io/cluster/${CLUSTER_NAME}: owned
  subnetSelectorTerms:
  - tags:
      karpenter.sh/discovery: "${CLUSTER_NAME}"
  - tags:
      aws:cloudformation:stack-name: "${CLUSTER_NAME}"
  userData: |
    MIME-Version: 1.0
    Content-Type: multipart/mixed; boundary="BOUNDARY"

    --BOUNDARY
    Content-Type: application/node.eks.aws

    apiVersion: node.eks.aws/v1alpha1
    kind: NodeConfig
    spec:
      cluster:
        name: ${CLUSTER_NAME}
        apiServerEndpoint: ${CLUSTER_ENDPOINT}  # Using the actual cluster endpoint
        certificateAuthority: ${CLUSTER_CA}
        cidr: "172.20.0.0/16"
      kubelet:
        config:
          nodeStatusReportFrequency: "60m"
          nodeLeaseDurationSeconds: 120
          maxPods: 110
          clusterDNS: ["172.20.0.10"]
        flags:
          - --node-labels=karpenter.sh/capacity-type=on-demand,karpenter.sh/nodepool=titan-pool
          - --register-with-taints=karpenter.sh/unregistered:NoExecute
    --BOUNDARY--