#Constants
{{$NODES_PER_NAMESPACE := MinInt .Nodes (DefaultParam .NODES_PER_NAMESPACE 100)}}
{{$IS_SMALL_CLUSTER := lt .Nodes 100}}
{{$PODS_PER_NODE := DefaultParam .PODS_PER_NODE 30}}
{{$ENABLE_NETWORK_POLICY_ENFORCEMENT_LATENCY_TEST := DefaultParam .CL2_ENABLE_NETWORK_POLICY_ENFORCEMENT_LATENCY_TEST false}}
# Variables
{{$namespaces := DivideInt .Nodes $NODES_PER_NAMESPACE}}
{{$totalPods := MultiplyInt $namespaces $NODES_PER_NAMESPACE $PODS_PER_NODE}}
{{$podsPerNamespace := DivideInt $totalPods $namespaces}}
# Command to be executed
{{$EXEC_COMMAND := DefaultParam .CL2_EXEC_COMMAND nil}}
{{$EXIT_AFTER_EXEC := DefaultParam .CL2_EXIT_AFTER_EXEC false}}
{{$EXEC_TIMEOUT := DefaultParam .CL2_EXEC_TIMEOUT "3600s"}}
{{$SLEEP_AFTER_EXEC_DURATION := DefaultParam .CL2_SLEEP_AFTER_EXEC_DURATION "0s"}}

{{$registry := DefaultParam .CL2_LATENCY_POD_REGISTRY "registry.k8s.io"}}
{{$latencyPodImage := DefaultParam .CL2_LATENCY_POD_IMAGE (Concat $registry "/pause:3.9")}}
{{$defaultQps := DefaultParam .CL2_DEFAULT_QPS (IfThenElse (le .Nodes 500) 10 100)}}
{{$uniformQps := DefaultParam .CL2_UNIFORM_QPS 500}}

name: load-eks-networking
namespace:
  number: {{$namespaces}}
tuningSets:
- name: Sequence
  parallelismLimitedLoad:
    parallelismLimit: 1
- name: UniformQPS
  qpsLoad:
    qps: {{$uniformQps}}
- name: default
  globalQPSLoad:
    qps: {{$defaultQps}}
    burst: 1
steps:
- module:
    path: /modules/measurements.yaml
    params:
      action: start
{{if $ENABLE_NETWORK_POLICY_ENFORCEMENT_LATENCY_TEST}}
- module:
    path: modules/network-policy/net-policy-enforcement-latency.yaml
    params:
      setup: true
      run: true
      testType: "pod-creation"
{{end}}
- module:
    path: modules/dns-k8s-hostnames.yaml
- name: Sleep
  measurements:
  - Identifier: WaitAfterExec
    Method: Sleep
    Params:
      duration: {{$SLEEP_AFTER_EXEC_DURATION}}
{{if $ENABLE_NETWORK_POLICY_ENFORCEMENT_LATENCY_TEST}}
- module:
    path: modules/network-policy/net-policy-metrics.yaml
    params:
      action: gather
      usePolicyCreationMetrics: false
- module:
    path: modules/network-policy/net-policy-enforcement-latency.yaml
    params:
      complete: true
      testType: "pod-creation"
- module:
    path: modules/network-policy/net-policy-enforcement-latency.yaml
    params:
      run: true
      testType: "policy-creation"
{{end}}
- module:
    path: /modules/measurements.yaml
    params:
      action: gather
{{if $ENABLE_NETWORK_POLICY_ENFORCEMENT_LATENCY_TEST}}
- module:
    path: modules/network-policy/net-policy-enforcement-latency.yaml
    params:
      complete: true
      testType: "policy-creation"
{{end}}
