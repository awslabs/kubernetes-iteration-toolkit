# density.yaml
# Internal module for density-based sustained load.

{{$totalSchedulerThroughputPods := DefaultParam .CL2_SCHEDULER_THROUGHPUT_PODS 5000}}

name: density-churn-module

steps:
- name: create-density-load
  phases:
    - name: creation-phase
      replicasPerNamespace: {{$totalSchedulerThroughputPods}} # Unusually high number of pods to hydrate the scheduler queue with a huge backlog
      namespaceRange:
        min: 1
        max: 1
      tuningSet: SteadyCreationQPS # This tuningSet defined in parent config
      objectBundle: 
        - basename: scheduler-churn-pod
          objectTemplatePath: pod-default.yaml
          templateFillMap:
            Group: continuous-churn

- name: wait-for-initial-density
  measurements:
    - Identifier: WaitForInitialPods
      Method: WaitForRunningPods
      Params:
        action: gather
        desiredPodCount: {{$totalSchedulerThroughputPods}}
        labelSelector: group = continuous-churn
        timeout: 2h

- name: start-continuous-cleanup
  phases:
    - name: long-cleanup-churn
      replicasPerNamespace: 0 
      namespaceRange:
        min: 1
        max: 1
      tuningSet: DefaultLowQPS # This tuningSet defined in parent config
      timeLimit: 2h
      objectBundle:
        - basename: scheduler-churn-pod
          listUnknownObjectOptions:
            labelSelector:
              matchLabels:
                group: continuous-churn
          objectTemplatePath: pod-default.yaml 
          templateFillMap:
            Group: continuous-churn
- name: wait-for-cleanup-completion
  measurements:
    - Identifier: WaitForPodsTerminated
      Method: WaitForRunningPods
      Params:
        action: gather
        desiredPodCount: 0
        labelSelector: group = continuous-churn
        timeout: 30m
