---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: kitloadtest
spec:
  workspaces:
    - name: config
    - name: source
    - name: results
  params:
  - name: cluster-name
    description: The name of the kit cluster you want to spin.
  - name: host-cluster-region
    default: "us-east-1"
    description: The region where the Host EKS cluster is in.
  - name: guest-cluster-region
    default: "us-west-2"
    description: The region where the kit cluster is created.
  - name: control-plane-spec
    description:  url to the controlplane spec.
  - name: dataplane-spec
    description: url to the dataplane spec.
  - name: giturl
    description: "git url to clone the package"
    default: https://github.com/kubernetes/perf-tests.git
  - name: pods-per-node
    description: "pod density"
    default: "10"
  - name: nodes-per-namespace
    description:  "nodes per namespace to get created for load test "
    default: "100"
  - name: cl2-load-test-throughput
    description: "throughput used for mutate operations"
    default: "15"
  - name: results-bucket
    description: "Results bucket with path of s3 to upload results"
  - name: desired-nodes
    description: The desired number of nodes in the cluster which we define in DataPlane spec.
  tasks:
  - name: create-kit-cluster
    taskRef:
      name: kit-cluster-create
    params:
      - name: cluster-name
        value: '$(params.cluster-name)'
      - name: host-cluster-region
        value: '$(params.host-cluster-region)'
      - name: guest-cluster-region
        value: '$(params.guest-cluster-region)'
      - name: control-plane-spec
        value: '$(params.control-plane-spec)'
      - name: dataplane-spec
        value: '$(params.dataplane-spec)'
    workspaces:
      - name: config    
        workspace: config
  - name: generate
    runAfter: [create-kit-cluster]
    taskRef:
      name: load
    params:
      - name: giturl
        value: '$(params.giturl)'
      - name: pods-per-node
        value: '$(params.pods-per-node)'
      - name: nodes-per-namespace
        value: '$(params.nodes-per-namespace)'
      - name: cl2-load-test-throughput
        value: '$(params.cl2-load-test-throughput)'
      - name: results-bucket
        value: '$(params.results-bucket)'
      - name: nodes
        value: '$(params.desired-nodes)'
    workspaces:
      - name: source
        workspace: source
      - name: config    
        workspace: config
      - name: results
        workspace: results
  - name: teardown
    runAfter: [generate]
    taskRef:
      name: kit-cluster-teardown
    params:
      - name: cluster-name
        value: '$(params.cluster-name)'
