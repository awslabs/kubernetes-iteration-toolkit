---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: sustained-scheduler-throughput
  namespace: scalability
spec:
  description: "clusterloader2 task to run various types of cl2 tests on a given cluster."
  params:
  - name: giturl
    description: "git url to clone the package"
    default: https://github.com/dheeraj-coding/perf-tests.git
  - name: cl2-branch
    description: "The branch of clusterloader2 you want to use"
    default: "steady-load"
  - name: cl2-scheduler-throughput-pods
    default: 500000
  - name: cl2-scheduler-throughput-threshold
    description: "scheduler throughput threshold"
    default: "150"
  - name: cl2-scheduler-steady-qps
    description: "pods scheduler steady qps"
    default: "170"
  - name: cl2-scheduler-create-qps
    default: "1700"
  - name: nodes
    description: "number of dataplane nodes to run the load test against"
    default: "1000"
  - name: results-bucket
    description: "Results bucket with path of s3 to upload results"
  - name: region
    default: "us-west-2"
    description: The region where the cluster is in.
  - name: cluster-name
    description: The name of the EKS cluster you want to spin.
  results:
    - name: datapoint
      description: Stores the CL2 result that can be consumed by other tasks (e.g. cloudwatch) 
    - name: s3_result
      description: Stores the S3 result path after compute
  workspaces:
  - name: source
    mountPath: /src/k8s.io/
  - name: results
  - name: config
    mountPath: /config/
  stepTemplate:
    env:
    - name: KUBECONFIG
      value: /config/kubeconfig
  steps:
  - name: git-clone      
    image: alpine/git
    workingDir: $(workspaces.source.path)
    script: |
      git clone $(params.giturl)
      cd $(workspaces.source.path)/perf-tests/
      git fetch origin --verbose --tags
      git checkout $(params.cl2-branch)
      git branch
  - name: prepare-loadtest
    image: golang:1.24
    workingDir: $(workspaces.source.path)
    script: |
      S3_RESULT_PATH=$(params.results-bucket)
      echo $S3_RESULT_PATH > $(results.s3_result.path)
      echo "S3 Path: $S3_RESULT_PATH" 
      cat > "$(workspaces.source.path)/overrides.yaml" <<EOL
      CL2_SCHEDULER_CREATE_QPS: $(params.cl2-scheduler-create-qps)
      CL2_SCHEDULER_STEADY_QPS: $(params.cl2-scheduler-steady-qps)
      CL2_SCHEDULER_THROUGHPUT_THRESHOLD: $(params.cl2-scheduler-throughput-threshold)
      EOL

      cat $(workspaces.source.path)/overrides.yaml
      cp $(workspaces.source.path)/overrides.yaml $(workspaces.results.path)/overrides.yaml
      
      # Building clusterloader2 binary 
      cd $(workspaces.source.path)/perf-tests/clusterloader2/
      GOOS=linux CGO_ENABLED=0  go build -v -o ./clusterloader ./cmd
  - name: run-loadtest
    image: alpine/k8s:1.30.2
    onError: continue
    script: |
      #!/bin/bash

      TOTAL_CYCLES=1
      cat $(workspaces.source.path)/perf-tests/clusterloader2/testing/scheduler-throughput/config.yaml
      cd $(workspaces.source.path)/perf-tests/clusterloader2/

      ENABLE_EXEC_SERVICE=false ./clusterloader --kubeconfig=$KUBECONFIG --testconfig=$(workspaces.source.path)/perf-tests/clusterloader2/testing/sustained-scheduler-throughput/config.yaml --testoverrides=$(workspaces.source.path)/overrides.yaml --nodes=$(params.nodes) --provider=eks --report-dir=$(workspaces.results.path) --alsologtostderr --v=2

      exit_code=$?
      if [ $exit_code -eq 0 ]; then
        echo "1" | tee $(results.datapoint.path)
      else
        echo "0" | tee $(results.datapoint.path)
      fi
      ls -a $(workspaces.results.path)
      cat $(workspaces.results.path)/SchedulingThroughput*
      exit $exit_code
    timeout: 30000s
  - name: upload-results
    image: amazon/aws-cli
    workingDir: $(workspaces.results.path)
    script: |
      S3_RESULT_PATH=$(cat $(results.s3_result.path))
      echo "S3 Path: $S3_RESULT_PATH" 
      aws sts get-caller-identity
      # we expect to see all files from loadtest that clusterloader2 outputs here in this dir
      ls -larth
      # aws s3 cp . s3://$S3_RESULT_PATH/  --recursive
