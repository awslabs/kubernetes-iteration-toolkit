apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name:  cloudwatch
  namespace: tekton-pipelines
spec:
  description: "cw task that can be used to create a metric and emit a datapoint based on the result that is passed after test."
  params:
    - name: region
      default: "us-west-2"
      description: "The region to use for publishing the metrics"
    - name: metric-name 
      default: "cl2-loadtest"
      description: "The name of the metric you want to pass"
    - name: namespace
      description: "The namespace for the metric data"
    - name: dimensions
      description: "Name of the dimension that you want to associate with the metric"
    - name: unit
      default: "Count"
      description: "Name of the unit you want to use when storing the metric."
    - name: value
      description: "The value for the metric"
  steps:
  - name: cw-emit
    image: amazon/aws-cli
    script: |
      aws sts get-caller-identity
      aws cloudwatch --region $(params.region) put-metric-data --metric-name $(params.metric-name) --namespace $(params.namespace) --dimensions Nodes=$(params.dimensions) --unit $(params.unit) --value $(params.value) 