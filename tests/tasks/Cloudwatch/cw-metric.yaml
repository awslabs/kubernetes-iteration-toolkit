apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name:  cloudwatch
  namespace: tekton-pipelines
spec:
  description: "cw task to push one data point to AWS CloudWatch."
  params:
    - name: region
      default: "us-west-2"
    - name: desired-nodes
    - name: load-result
  steps:
  - name: cw-emit
    image: amazon/aws-cli
    script: |
      aws sts get-caller-identity
      if [[ "$(params.load-result)" -eq 0 ]]; then
      aws cloudwatch --region $(params.region) put-metric-data --metric-name cl2-loadtest --namespace k8s-version --unit Count --value 1 --dimensions Nodes=$(params.desired-nodes)
      else
      aws cloudwatch --region $(params.region) put-metric-data --metric-name cl2-loadtest --namespace k8s-version --unit Count --value 0 --dimensions Nodes=$(params.desired-nodes)
      fi