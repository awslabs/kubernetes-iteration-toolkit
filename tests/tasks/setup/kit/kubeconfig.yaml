apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: kit-retrieve-kubeconfig
  namespace: tekton-pipelines
spec:
  description: "retrieve the kubeconfig for the kit guest cluster"
  params:
    - name: cluster-name
      default: "guest"
      description: "The kit guest cluster name"
  steps:
  - name: retrieve-kubeconfig
    image: bitnami/kubectl
    script: |
      echo $(workspaces.kubeconfig.path)
      ls -ld $(workspaces.kubeconfig.path)
      kubectl get secret -n $(params.cluster-name) $(params.cluster-name)-kube-admin-config -ojsonpath='{.data.config}' | base64 -d > $(workspaces.kubeconfig.path)/kubeconfig
      # TODO: remove debug
      cat $(workspaces.kubeconfig.path)/kubeconfig
      # sanity check to ensure it's live.
      kubectl --kubeconfig $(workspaces.kubeconfig.path)/kubeconfig version
  workspaces:
  - name: kubeconfig
    description: kubeconfig of the guest cluster
